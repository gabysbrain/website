version: 2.1

executors:
  basic:
    docker:
      - image: cimg/base:2020.01
  node:
    docker:
      - image: circleci/node:current
  nixos:
    docker:
      - image: nixos/nix:latest
        #working_directory: /tmp
  nm_alt:
    docker:
      - image: lnl7/nix:latest
        #working_directory: /tmp

workflows:
  deploy_prod:
    jobs:
      - build
      - deploy_prod:
          requires:
            - build

jobs:
  build:
    executor: nixos
    steps:
      - restore_cache:
          keys:
            - nix-cache
      - run:
          name: Install dependencies
          command: |
            nix-channel --update
            nix-env -u
            nix-env -iA nixpkgs.pandoc
      - checkout
      - run: 
          name: build website
          command: nix-build
      - run: 
          name: copy website to workplace
          command: |
            mkdir -p workspace/build
            cp -R $(nix-build --no-out-link)/* workspace/build/
      - save_cache:
          key: nix-cache
          paths:
            - /nix/store
      - persist_to_workspace:
          root: workspace
          paths:
            - build

  deploy_prod:
    executor: node
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - run:
          name: Install and configure dependencies
          command: |
            npm install
            git config user.email "ci-build@tomtorsneyweir.com"
            git config user.name "ci-build"
      - run:
          name: Disable jekyll builds
          command: touch workspace/build/.nojekyll
      - run:
          name: setup CNAME file
          command: echo www.tomtorsneyweir.com > workspace/build/CNAME
      - add_ssh_keys:
          fingerprints:
            - "04:20:b3:77:32:f8:06:6f:02:39:01:d3:85:54:e0:15"
      - run:
          name: Deploy to gh-pages branch
          command: npm run deploy
          #node_modules/gh-pages/bin/gh-pages.js --dotfiles --message "[skip ci] Updates" --dist workspace/build

